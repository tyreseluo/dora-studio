name: Build Makepad (All Platforms)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      build_desktop:
        description: "Build desktop packages"
        type: boolean
        default: true
      build_android:
        description: "Build Android APK"
        type: boolean
        default: true
      build_ios:
        description: "Build iOS app"
        type: boolean
        default: true
      release_tag:
        description: "Release tag (optional, supports __VERSION__)"
        type: string
        default: ""
      release_name:
        description: "Release name (optional, supports __VERSION__)"
        type: string
        default: ""
      release_body:
        description: "Release body (optional)"
        type: string
        default: ""
      release_draft:
        description: "Create draft release"
        type: boolean
        default: false
      prerelease:
        description: "Mark as prerelease"
        type: boolean
        default: false
      args:
        description: "Extra args passed to the action"
        type: string
        default: ""

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  # Create release first (only once)
  create-release:
    name: Create Release
    runs-on: ubuntu-22.04
    outputs:
      release_tag: ${{ steps.get_tag.outputs.tag }}
      release_upload_url: ${{ steps.create_release.outputs.upload_url }}
      release_id: ${{ steps.create_release.outputs.id }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get tag
        id: get_tag
        run: |
          if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref_type }}" = "tag" ]; then
            echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          elif [ -n "${{ inputs.release_tag }}" ]; then
            echo "tag=${{ inputs.release_tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=v$(date +'%Y%m%d%H%M%S')" >> $GITHUB_OUTPUT
          fi

      - name: Get release name
        id: get_name
        run: |
          if [ -n "${{ inputs.release_name }}" ]; then
            echo "name=${{ inputs.release_name }}" >> $GITHUB_OUTPUT
          else
            echo "name=Dora Studio ${{ steps.get_tag.outputs.tag }}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_tag.outputs.tag }}
          name: ${{ steps.get_name.outputs.name }}
          body: |
            ${{ inputs.release_body != '' && inputs.release_body || '## Dora Studio Release

            ### Downloads
            See the assets below for platform-specific downloads.

            ### Platforms
            - macOS (Apple Silicon)
            - Linux (x86_64)
            - Windows (x86_64)
            - Android (arm64)
            - iOS (arm64)' }}
          draft: ${{ inputs.release_draft || false }}
          prerelease: ${{ inputs.prerelease || false }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  desktop:
    name: Desktop (${{ matrix.name }})
    needs: create-release
    if: ${{ always() && (github.event_name == 'push' || inputs.build_desktop) }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            packager_formats: deb
            name: Linux
          - os: macos-14
            packager_formats: dmg
            name: macOS
          - os: windows-2022
            packager_formats: nsis
            name: Windows

    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Linux dependencies
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          sudo apt-get update
          sudo apt-get install libssl-dev pkg-config llvm clang libclang-dev binfmt-support libxcursor-dev libx11-dev libasound2-dev libpulse-dev libwayland-dev libxkbcommon-dev

      - name: Package (desktop)
        uses: Project-Robius-China/makepad-packaging-action@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          releaseId: ${{ needs.create-release.outputs.release_id }}
          args: ${{ inputs.args }}
          packager_formats: ${{ matrix.packager_formats }}

  android:
    name: Android
    needs: create-release
    if: ${{ always() && (github.event_name == 'push' || inputs.build_android) }}
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-makepad
        run: cargo install --force --git https://github.com/makepad/makepad.git --branch dev cargo-makepad

      - name: Install Android toolchain (makepad)
        run: cargo makepad android install-toolchain --full-ndk

      - name: Build OpenSSL for Android (aarch64)
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y build-essential perl pkg-config curl

          SDK_DIR=$(find ~/.cargo -type d -name android_33_linux_x64 -print -quit)
          if [ -z "$SDK_DIR" ]; then
            echo "Android SDK not found under ~/.cargo; cargo-makepad install-toolchain may have failed." >&2
            exit 1
          fi

          NDK_VERSION="25.2.9519653"
          NDK_ROOT="$SDK_DIR/ndk/$NDK_VERSION"
          if [ ! -d "$NDK_ROOT" ]; then
            echo "NDK not found at $NDK_ROOT" >&2
            ls -la "$SDK_DIR/ndk" || true
            exit 1
          fi

          OPENSSL_VERSION="3.0.13"
          WORKDIR="${RUNNER_TEMP:-/tmp}/openssl-android"
          mkdir -p "$WORKDIR"
          cd "$WORKDIR"

          curl -L "https://www.openssl.org/source/openssl-${OPENSSL_VERSION}.tar.gz" | tar xz
          cd "openssl-${OPENSSL_VERSION}"

          export ANDROID_NDK_HOME="$NDK_ROOT"
          export ANDROID_API=21
          export PATH="$NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"
          export CC="aarch64-linux-android${ANDROID_API}-clang"
          export AR="llvm-ar"
          export RANLIB="llvm-ranlib"
          export STRIP="llvm-strip"
          ./Configure android-arm64 -D__ANDROID_API__=$ANDROID_API --prefix=$PWD/_install no-shared
          make -j"$(nproc)"
          make install_sw

          echo "OPENSSL_DIR=$PWD/_install" >> $GITHUB_ENV
          echo "OPENSSL_LIB_DIR=$PWD/_install/lib" >> $GITHUB_ENV
          echo "OPENSSL_INCLUDE_DIR=$PWD/_install/include" >> $GITHUB_ENV
          echo "AARCH64_LINUX_ANDROID_OPENSSL_DIR=$PWD/_install" >> $GITHUB_ENV
          echo "AARCH64_LINUX_ANDROID_OPENSSL_LIB_DIR=$PWD/_install/lib" >> $GITHUB_ENV
          echo "AARCH64_LINUX_ANDROID_OPENSSL_INCLUDE_DIR=$PWD/_install/include" >> $GITHUB_ENV
          echo "PKG_CONFIG_ALLOW_CROSS=1" >> $GITHUB_ENV
          echo "OPENSSL_STATIC=1" >> $GITHUB_ENV

      - name: Package (android)
        uses: Project-Robius-China/makepad-packaging-action@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          releaseId: ${{ needs.create-release.outputs.release_id }}
          args: --target aarch64-linux-android ${{ inputs.args }}

  ios:
    name: iOS
    needs: create-release
    if: ${{ always() && (github.event_name == 'push' || inputs.build_ios) }}
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Package (iOS)
        uses: Project-Robius-China/makepad-packaging-action@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MAKEPAD_IOS_ORG: com.mofa
          MAKEPAD_IOS_APP: dora-studio
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_PROVISIONING_PROFILE: ${{ secrets.APPLE_PROVISIONING_PROFILE }}
          APPLE_KEYCHAIN_PASSWORD: ${{ secrets.APPLE_KEYCHAIN_PASSWORD }}
        with:
          releaseId: ${{ needs.create-release.outputs.release_id }}
          args: --target aarch64-apple-ios ${{ inputs.args }}
